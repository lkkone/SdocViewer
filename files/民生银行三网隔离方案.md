# 民生银行三网隔离方案

```bash
nginx-ingress-controller配置


apiVersion: v1
data:                #data下添加如下配置
...
  http-snippet: |
    geo $remote_addr {
      default "develop";
      28.7.231.237 "office";
      28.4.0.0/18 "develop";

    map $the_real_ip $http_network_env {
      default "office";
      "develop" "develop";
    }
...
```

- geo 用来根据 **客户端 IP** 设置一个变量。
- 这里定义了一个变量 $remote_addr 的“映射表”：
  - 如果 IP 精确等于 **28.7.231.237** → 值设为 "office"
  - 如果 IP 落在 **28.4.0.0/18** 这个网段 → 值设为 "develop"
  - **其他所有 IP** → 值设为 "develop"（因为 default "develop"）

- map 用来把一个变量的值，映射成另一个变量。
- 输入是 $the_real_ip，输出存放到 $http_network_env。
- 规则：
  - 如果 $the_real_ip 的值等于 "develop" → $http_network_env 设为 "develop"
  - 否则（包括 "office" 和任何其他情况） → $http_network_env 设为 "office"（因为 default "office"）



## **3. 两段结合起来的逻辑**

1. **geo 阶段**：根据客户端 IP，把 $remote_addr 赋值为 "office" 或 "develop"（默认 develop）。
2. **map 阶段**：再根据 $remote_addr 的值，映射得到 $http_network_env：
   - 如果 $remote_addr = "develop" → $http_network_env = "develop"
   - 其他（比如 $remote_addr = "office"） → $http_network_env = "office"

- 28.7.231.237 → $http_network_env = office
- 28.4.0.0/18 网段 → $http_network_env = develop
- 其他所有 IP → $http_network_env = develop

最后的 $http_network_env 就可以在后续 Nginx 配置里用（比如做请求头透传、反向代理路由选择等）。

常见用途：

- 给后端服务加一个 X-Network-Env: office/develop 请求头
- 或者在 Ingress 的 server/location block 里做条件判断，分环境路由。

![Matplotlib Chart2](/Users/likaikai/Downloads/Matplotlib Chart2.png)

https://nginx.org/en/docs/http/ngx_http_geo_module.html